<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人物品分类记录系统 - 弹窗版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="text-gray-800">
    <div id="app" class="min-h-screen flex flex-col md:flex-row">
        
        <aside class="w-full md:w-64 bg-white shadow-lg z-10 flex-shrink-0 flex flex-col h-auto md:h-screen fixed md:sticky top-0">
            <div class="p-6 bg-blue-600 text-white">
                <h1 class="text-2xl font-bold"><i class="fas fa-boxes mr-2"></i>我的储物间</h1>
                <p class="text-blue-100 text-sm mt-1">记录物品，不再丢三落四</p>
            </div>
            
            <nav class="flex-1 overflow-y-auto p-4 space-y-2">
                <div class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">筛选视图</div>
                
                <button @click="setFilter('all')" 
                    :class="{'bg-blue-50 text-blue-600': filterType === 'all'}"
                    class="w-full text-left px-4 py-2 rounded-lg hover:bg-gray-100 transition flex items-center">
                    <i class="fas fa-th-large w-6"></i> 全部物品
                    <span class="ml-auto bg-gray-200 text-gray-600 text-xs px-2 py-0.5 rounded-full">{{ items.length }}</span>
                </button>

                <div class="mt-6 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">按位置查看</div>
                <button v-for="loc in uniqueLocations" :key="loc" @click="setFilter('location', loc)"
                    :class="{'bg-blue-50 text-blue-600': filterType === 'location' && filterValue === loc}"
                    class="w-full text-left px-4 py-2 rounded-lg hover:bg-gray-100 transition flex items-center">
                    <i class="fas fa-map-marker-alt w-6 text-red-400"></i> {{ loc }}
                    <span class="ml-auto bg-gray-200 text-gray-600 text-xs px-2 py-0.5 rounded-full">{{ getLocationCount(loc) }}</span>
                </button>

                 <div class="mt-6 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">按分类查看</div>
                 <button v-for="cat in uniqueCategories" :key="cat" @click="setFilter('category', cat)"
                     :class="{'bg-blue-50 text-blue-600': filterType === 'category' && filterValue === cat}"
                     class="w-full text-left px-4 py-2 rounded-lg hover:bg-gray-100 transition flex items-center">
                     <i class="fas fa-tag w-6 text-green-400"></i> {{ cat }}
                     <span class="ml-auto bg-gray-200 text-gray-600 text-xs px-2 py-0.5 rounded-full">{{ getCategoryCount(cat) }}</span>
                 </button>
            </nav>

            <div class="p-4 border-t border-gray-100">
                <button @click="openAddCategoryModal" class="w-full text-left text-sm text-gray-500 hover:text-blue-600 py-1"><i class="fas fa-plus-circle mr-2"></i> 添加分类</button>
                <button @click="exportData" class="w-full text-left text-sm text-gray-500 hover:text-blue-600 py-1 mt-2"><i class="fas fa-download mr-2"></i> 备份数据</button>
                <button @click="$refs.fileInput.click()" class="w-full text-left text-sm text-gray-500 hover:text-blue-600 py-1"><i class="fas fa-upload mr-2"></i> 导入数据</button>
                <input type="file" ref="fileInput" @change="importData" style="display:none" accept=".json">
            </div>
        </aside>

        <main class="flex-1 p-4 md:p-8 overflow-y-auto">
            <div class="max-w-4xl mx-auto mb-8">
                <div class="relative group">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400 group-focus-within:text-blue-500"></i>
                    </div>
                    <input v-model="searchQuery" 
                        type="text" 
                        class="block w-full pl-12 pr-4 py-4 bg-white border-0 rounded-2xl shadow-sm ring-1 ring-gray-200 placeholder:text-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none transition" 
                        placeholder="搜索物品名称、位置或备注...">
                    <button @click="openAddModal" class="absolute right-2 top-2 bottom-2 bg-blue-600 hover:bg-blue-700 text-white px-6 rounded-xl transition flex items-center font-medium shadow-md">
                        <i class="fas fa-plus mr-2"></i> 记一笔
                    </button>
                </div>
            </div>

            <div class="max-w-4xl mx-auto mb-6 flex justify-between items-end">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">{{ currentViewTitle }}</h2>
                    <p class="text-gray-500 text-sm mt-1">找到 {{ filteredItems.length }} 个物品</p>
                </div>
                <div>
                    <button @click="openAddCategoryModal" class="text-sm text-gray-500 hover:text-blue-600 flex items-center">
                        <i class="fas fa-plus mr-1"></i> 添加分类
                    </button>
                </div>
            </div>

            <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div v-for="item in filteredItems" :key="item.id" class="glass-card rounded-xl p-5 hover:shadow-md transition relative group border-l-4 border-blue-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-lg text-gray-800">{{ item.name }}</h3>
                            <div class="flex items-center text-sm text-gray-500 mt-1">
                                <span class="bg-red-50 text-red-600 px-2 py-0.5 rounded text-xs mr-2 border border-red-100">
                                    <i class="fas fa-map-marker-alt mr-1"></i>{{ item.location }}
                                </span>
                                <span class="bg-green-50 text-green-600 px-2 py-0.5 rounded text-xs border border-green-100">
                                    <i class="fas fa-tag mr-1"></i>{{ item.category }}
                                </span>
                            </div>
                        </div>
                        <div class="opacity-0 group-hover:opacity-100 transition">
                            <button @click="editItem(item)" class="text-blue-500 hover:bg-blue-50 p-2 rounded-full"><i class="fas fa-edit"></i></button>
                            <button @click="deleteItem(item.id)" class="text-red-500 hover:bg-red-50 p-2 rounded-full"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                    <p v-if="item.note" class="mt-3 text-gray-600 text-sm bg-gray-50 p-2 rounded border border-gray-100">
                        {{ item.note }}
                    </p>
                    <div class="mt-3 text-xs text-gray-400 text-right">
                        更新于: {{ new Date(item.updatedAt).toLocaleDateString() }}
                    </div>
                </div>
                
                <div v-if="filteredItems.length === 0" class="col-span-full text-center py-20 text-gray-400">
                    <i class="fas fa-box-open text-6xl mb-4 text-gray-300"></i>
                    <p class="text-lg">这里空空如也</p>
                    <p class="text-sm">点击右上角"记一笔"开始整理你的生活吧</p>
                </div>
            </div>
        </main>

        <!-- 添加/编辑物品模态框 -->
        <div v-if="showItemModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
            <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl p-6 transform transition-all scale-100">
                <h3 class="text-xl font-bold mb-4">{{ isEditing ? '编辑物品' : '添加新物品' }}</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">物品名称 <span class="text-red-500">*</span></label>
                        <input v-model="form.name" type="text" class="w-full border rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="例如：护照、备用钥匙">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">存放位置 <span class="text-red-500">*</span></label>
                            <input v-model="form.location" list="locations-list" type="text" class="w-full border rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="例如：主卧床头柜">
                            <datalist id="locations-list">
                                <option v-for="loc in uniqueLocations" :key="loc" :value="loc"></option>
                            </datalist>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">分类</label>
                            <input v-model="form.category" list="categories-list" type="text" class="w-full border rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="例如：证件">
                            <datalist id="categories-list">
                                <option v-for="cat in uniqueCategories" :key="cat" :value="cat"></option>
                            </datalist>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">备注信息</label>
                        <textarea v-model="form.note" rows="3" class="w-full border rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="具体放在哪一层，或者其他需要注意的事项..."></textarea>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button @click="showItemModal = false" class="px-5 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg transition">取消</button>
                    <button @click="saveItem" class="px-5 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-lg disabled:opacity-50" :disabled="!form.name || !form.location">保存</button>
                </div>
            </div>
        </div>

        <!-- 添加分类模态框 -->
        <div v-if="showCategoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
            <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl p-6 transform transition-all scale-100">
                <h3 class="text-xl font-bold mb-4">添加新分类</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">分类名称 <span class="text-red-500">*</span></label>
                        <input v-model="newCategoryName" type="text" class="w-full border rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="例如：证件、电子产品、衣物">
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button @click="showCategoryModal = false" class="px-5 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg transition">取消</button>
                    <button @click="saveCategory" class="px-5 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-lg disabled:opacity-50" :disabled="!newCategoryName">添加</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                // 默认示例数据
                const defaultItems = [
                    { id: 1, name: '户口本', location: '主卧衣柜', category: '证件', note: '最上面的抽屉里，蓝色文件袋', updatedAt: Date.now() },
                    { id: 2, name: 'Switch游戏机', location: '客厅电视柜', category: '数码', note: '左边抽屉，连着充电线', updatedAt: Date.now() },
                    { id: 3, name: '感冒药', location: '厨房吊柜', category: '医药', note: '急救箱里', updatedAt: Date.now() }
                ];

                const items = ref([]);
                const searchQuery = ref('');
                const showItemModal = ref(false);
                const showCategoryModal = ref(false);
                const isEditing = ref(false);
                const filterType = ref('all'); // 'all', 'location', 'category
                const filterValue = ref('');

                // 表单数据
                const form = ref({
                    id: null,
                    name: '',
                    location: '',
                    category: '',
                    note: ''
                });

                // 分类表单数据
                const newCategoryName = ref('');

                // 初始化
                onMounted(() => {
                    const saved = localStorage.getItem('locker_items');
                    if (saved) {
                        items.value = JSON.parse(saved);
                    } else {
                        items.value = defaultItems;
                    }
                });

                // 监听数据变化自动保存
                watch(items, (newVal) => {
                    localStorage.setItem('locker_items', JSON.stringify(newVal));
                }, { deep: true });

                // 计算属性：提取唯一的地点和分类
                const uniqueLocations = computed(() => [...new Set(items.value.map(i => i.location))]);
                const uniqueCategories = computed(() => [...new Set(items.value.map(i => i.category))]);

                // 核心逻辑：过滤物品
                const filteredItems = computed(() => {
                    let result = items.value;

                    // 1. 侧边栏筛选
                    if (filterType.value === 'location') {
                        result = result.filter(i => i.location === filterValue.value);
                    } else if (filterType.value === 'category') {
                        result = result.filter(i => i.category === filterValue.value);
                    }

                    // 2. 搜索框筛选 (支持搜名字、地点、备注)
                    if (searchQuery.value) {
                        const q = searchQuery.value.toLowerCase();
                        result = result.filter(i => 
                            i.name.toLowerCase().includes(q) || 
                            i.location.toLowerCase().includes(q) || 
                            (i.note && i.note.toLowerCase().includes(q))
                        );
                    }
                    
                    // 按时间倒序排列
                    return result.sort((a, b) => b.updatedAt - a.updatedAt);
                });

                const currentViewTitle = computed(() => {
                    if (searchQuery.value) return `搜索: "${searchQuery.value}"`;
                    if (filterType.value === 'location') return `位置: ${filterValue.value}`;
                    if (filterType.value === 'category') return `分类: ${filterValue.value}`;
                    return '所有物品';
                });

                // 获取特定位置的物品数量
                const getLocationCount = (location) => {
                    return items.value.filter(item => item.location === location).length;
                };

                // 获取特定分类的物品数量
                const getCategoryCount = (category) => {
                    return items.value.filter(item => item.category === category).length;
                };

                // 设置筛选条件
                const setFilter = (type, value = '') => {
                    filterType.value = type;
                    filterValue.value = value;
                    searchQuery.value = ''; // 清空搜索
                };

                // 打开添加物品模态框
                const openAddModal = () => {
                    isEditing.value = false;
                    form.value = { name: '', location: '', category: '', note: '' };
                    showItemModal.value = true;
                };

                // 编辑物品
                const editItem = (item) => {
                    isEditing.value = true;
                    form.value = { ...item };
                    showItemModal.value = true;
                };

                // 保存物品
                const saveItem = () => {
                    if (!form.value.name || !form.value.location) return;
                    
                    if (isEditing.value) {
                        const index = items.value.findIndex(i => i.id === form.value.id);
                        if (index !== -1) {
                            items.value[index] = { ...form.value, updatedAt: Date.now() };
                        }
                    } else {
                        items.value.push({
                            ...form.value,
                            id: Date.now(),
                            updatedAt: Date.now()
                        });
                    }
                    showItemModal.value = false;
                };

                // 删除物品
                const deleteItem = (id) => {
                    if (confirm('确定要删除这条记录吗？')) {
                        items.value = items.value.filter(i => i.id !== id);
                    }
                };

                // 打开添加分类模态框
                const openAddCategoryModal = () => {
                    newCategoryName.value = '';
                    showCategoryModal.value = true;
                };

                // 保存新分类
                const saveCategory = () => {
                    if (!newCategoryName.value.trim()) return;
                    
                    // 检查分类是否已存在
                    if (!uniqueCategories.value.includes(newCategoryName.value.trim())) {
                        // 创建一个临时物品来添加新的分类
                        const tempItem = {
                            id: Date.now(),
                            name: 'temp',
                            location: 'temp',
                            category: newCategoryName.value.trim(),
                            note: '',
                            updatedAt: Date.now()
                        };
                        
                        // 添加临时物品
                        items.value.push(tempItem);
                        
                        // 立即删除临时物品（仅为了添加分类）
                        setTimeout(() => {
                            items.value = items.value.filter(i => i.name !== 'temp' || i.location !== 'temp');
                        }, 10);
                        
                        showCategoryModal.value = false;
                        newCategoryName.value = '';
                    } else {
                        alert('该分类已存在！');
                    }
                };

                // 导出数据
                const exportData = () => {
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(items.value));
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", "储物间备份_" + new Date().toLocaleDateString() + ".json");
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                };

                // 导入数据
                const importData = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const imported = JSON.parse(e.target.result);
                            if (confirm(`准备导入 ${imported.length} 条数据，这将覆盖现有数据，确定吗？`)) {
                                items.value = imported;
                                alert('导入成功！');
                            }
                        } catch (err) {
                            alert('文件格式错误，请导入正确的JSON备份文件');
                        }
                    };
                    reader.readAsText(file);
                };

                return {
                    items, searchQuery, showItemModal, showCategoryModal, isEditing, form, newCategoryName,
                    uniqueLocations, uniqueCategories, filteredItems, currentViewTitle,
                    filterType, filterValue,
                    setFilter, openAddModal, editItem, saveItem, deleteItem,
                    openAddCategoryModal, saveCategory,
                    exportData, importData, getLocationCount, getCategoryCount
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
